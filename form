<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demande de Devis</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .toggle-checkbox:checked { right: 0; border-color: #2563EB; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2563EB; }
        body { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-slate-800 min-h-screen flex items-center justify-center p-4 font-sans text-slate-800">

    <div id="root" class="w-full max-w-4xl"></div>

    <script type="text/babel">
        const { useState } = React;

        // --- ICONES ---
        const Trash2 = ({ size = 20, className = "" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>);
        const Plus = ({ size = 20, className = "" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>);
        const Check = ({ size = 20, className = "" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"></polyline></svg>);
        const ChevronRight = ({ size = 20, className = "" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"></polyline></svg>);
        const ChevronLeft = ({ size = 20, className = "" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="15 18 9 12 15 6"></polyline></svg>);
        const Hand = ({ size = 20, className = "" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"></path><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"></path><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"></path><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"></path></svg>);
        const ShieldCheck = ({ size = 20, className = "" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>);

        // --- COMPOSANT PRINCIPAL ---
        const QuoteForm = () => {
            const WEBHOOK_URL = "https://hook.eu1.make.com/87l2637pu1ol9m6ksl75evieh3s9j1vg";
            const REDIRECT_URL = "https://monsacpoubelle.fr/content/14-confirmation-formulaire";

            const [step, setStep] = useState(1);
            const [loading, setLoading] = useState(false);
            const [isManualRequest, setIsManualRequest] = useState(false);
            const [productLines, setProductLines] = useState([
                { id: 1, type: '', volume: '', quantity: '', hasLogo: false }
            ]);
            
            const [manualText, setManualText] = useState('');
            const [deliveryInfo, setDeliveryInfo] = useState({
                deliveryDelay: '', companyName: '', sector: '', zipCode: ''
            });
            const [contactInfo, setContactInfo] = useState({
                name: '', email: '', phone: ''
            });

            const sacTypes = ["Standard renforc√© (BTP)", "DASRI (m√©dicale)", "Tri s√©lectif", "Biod√©gradable", "Grands contenants", "Autres"];
            const volumeOptions = ["Moins de 10 litres", "10 √† 100 litres", "100 √† 200 litres", "200 √† 300 litres", "300 √† 400 litres", "400 √† 1000 litres", "Autres"];
            const quantityOptions = ["Moins de 500", "500 √† 1000", "1000 √† 5000", "Plus de 5000", "Autres"];
            const deliveryDelays = ["Moins de 24 heures", "24 heures", "48 heures", "72 heures"];

            // --- TRACKING INTELLIGENT (Cible le GTM parent) ---
            const trackEvent = (eventName, params = {}) => {
                try {
                    // Cible le dataLayer du site parent (si iframe) ou le dataLayer local
                    const targetDataLayer = (window.parent && window.parent.dataLayer) ? window.parent.dataLayer : (window.dataLayer || []);
                    
                    // Si on a trouv√© un dataLayer (tableau), on push
                    if (Array.isArray(targetDataLayer) || (targetDataLayer.push)) {
                        targetDataLayer.push({
                            event: eventName,
                            ...params
                        });
                        console.log(`üì° Event sent to GTM: ${eventName}`);
                    }
                } catch (e) {
                    console.warn("Tracking error:", e);
                }
            };

            // Logic
            const addProductLine = () => {
                const newId = productLines.length > 0 ? Math.max(...productLines.map(p => p.id)) + 1 : 1;
                setProductLines([...productLines, { id: newId, type: '', volume: '', quantity: '', hasLogo: false }]);
                trackEvent('add_product_line', { new_count: productLines.length + 1 });
            };

            const removeProductLine = (id) => {
                setProductLines(productLines.filter(line => line.id !== id));
                trackEvent('remove_product_line', { removed_id: id });
            };

            const updateProductLine = (id, field, value) => {
                setProductLines(productLines.map(line => 
                line.id === id ? { ...line, [field]: value } : line
                ));
            };

            const toggleManualMode = () => {
                const newState = !isManualRequest;
                setIsManualRequest(newState);
                trackEvent('toggle_manual_mode', { active: newState });
            }

            const validateStep1 = () => {
                if (isManualRequest) return manualText.trim().length > 0;
                return productLines.length > 0 && productLines.every(l => l.type && l.volume && l.quantity);
            };

            const validateStep2 = () => {
                return deliveryInfo.deliveryDelay && deliveryInfo.companyName && deliveryInfo.sector && deliveryInfo.zipCode;
            };

            const validateStep3 = () => {
                return contactInfo.name && contactInfo.email && contactInfo.phone;
            };

            const handleNext = () => {
                if (step === 1 && !validateStep1()) {
                    alert("Veuillez remplir les informations produits ou d√©crire votre besoin.");
                    trackEvent('form_error', { step: 1, type: 'validation_fail' });
                    return;
                }
                if (step === 2 && !validateStep2()) {
                    alert("Veuillez remplir tous les champs de livraison et d'entreprise.");
                    trackEvent('form_error', { step: 2, type: 'validation_fail' });
                    return;
                }
                
                trackEvent('step_complete', { step_finished: step });
                setStep(prev => prev + 1);
            };

            const handlePrev = () => {
                trackEvent('step_back', { from_step: step });
                setStep(prev => prev - 1);
            };

            const handleDelaySelect = (delay) => {
                setDeliveryInfo({...deliveryInfo, deliveryDelay: delay});
                trackEvent('select_delivery_delay', { value: delay });
            };

            const handleSubmit = async () => {
                if (!validateStep3()) {
                    trackEvent('form_error', { step: 3, type: 'missing_contact' });
                    return;
                }
                setLoading(true);

                let formattedContent = "";
                if (isManualRequest) {
                    formattedContent = manualText;
                } else {
                    formattedContent = productLines.map((line, index) => 
                        `Ligne ${index + 1} : ${line.type} | ${line.volume} | Quantit√©: ${line.quantity} | Logo: ${line.hasLogo ? 'OUI' : 'NON'}`
                    ).join('\n');
                }

                const payload = {
                    type_demande: isManualRequest ? "Manuelle" : "Liste de produits",
                    contenu_demande: formattedContent,
                    livraison: deliveryInfo,
                    contact: contactInfo,
                    date_soumission: new Date().toISOString()
                };

                trackEvent('form_submit_attempt');

                try {
                    const response = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (response.ok) {
                        // Tracking de s√©curit√© (tentative d'envoi avant redirection)
                        trackEvent('form_submit_success', { sector: deliveryInfo.sector });
                        
                        // --- REDIRECTION ICI ---
                        // On utilise window.top pour sortir de l'iframe √©ventuelle
                        setTimeout(() => {
                            window.top.location.href = REDIRECT_URL;
                        }, 100); // Petit d√©lai de 100ms pour laisser le temps au tracking de partir
                        
                    } else {
                        trackEvent('form_submit_error', { reason: 'server_error' });
                        alert("Une erreur est survenue lors de l'envoi. Veuillez r√©essayer.");
                        setLoading(false);
                    }
                } catch (error) {
                    console.error("Erreur:", error);
                    trackEvent('form_submit_error', { reason: 'network_error' });
                    alert("Erreur de connexion.");
                    setLoading(false);
                }
                // Note : On ne met pas setLoading(false) dans le bloc success car on change de page
            };

            // Render
            const ProgressBar = () => (
                <div className="flex justify-between items-center mb-8 px-4">
                    {[1, 2, 3].map((num) => (
                        <div key={num} className="flex flex-col items-center flex-1 relative">
                            <div className={`w-full h-1 absolute top-1/2 -translate-y-1/2 -z-10 ${num === 1 ? 'left-1/2' : num === 3 ? 'right-1/2' : ''} bg-gray-200 hidden md:block`}></div>
                            <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm transition-all duration-300 z-10 ${step >= num ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-500'}`}>
                                {step > num ? <Check size={16} /> : num}
                            </div>
                        </div>
                    ))}
                </div>
            );

            return (
                <div className="bg-white w-full rounded-xl shadow-2xl overflow-hidden min-h-[500px] flex flex-col">
                    {/* Header */}
                    <div className="bg-gray-50 border-b p-6 flex items-center gap-3">
                        <div className="bg-yellow-400 p-2 rounded-full text-white">
                            <Hand size={20} className="fill-current" />
                        </div>
                        <div>
                            <h1 className="text-xl font-bold text-blue-900">Devis gratuit et personnalis√©</h1>
                            <p className="text-sm text-gray-500">R√©ponse sous 24h garantie</p>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="p-6 md:p-8 flex-1 flex flex-col">
                        <ProgressBar />

                        {/* STEP 1 */}
                        {step === 1 && (
                            <div className="animate-fade-in space-y-6">
                                <p className="text-gray-700 font-medium">D√©crivez vos besoins pour recevoir un devis gratuit aux meilleurs prix du march√©.</p>
                                {!isManualRequest ? (
                                    <>
                                        <div className="space-y-4">
                                            {productLines.map((line, index) => (
                                                <div key={line.id} className="p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm relative transition-all hover:shadow-md">
                                                    <div className="flex justify-between items-center mb-3">
                                                        <span className="font-semibold text-blue-800">Ligne produit #{index + 1}</span>
                                                        {productLines.length > 1 && (
                                                            <button onClick={() => removeProductLine(line.id)} className="text-red-500 hover:text-red-700">
                                                                <Trash2 size={18} />
                                                            </button>
                                                        )}
                                                    </div>
                                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700 mb-1">Type de sac *</label>
                                                            <select className="w-full border-gray-300 rounded-md border p-2 focus:ring-2 focus:ring-blue-500 outline-none" value={line.type} onChange={(e) => updateProductLine(line.id, 'type', e.target.value)}>
                                                                <option value="">S√©lectionner</option>
                                                                {sacTypes.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700 mb-1">Taille / Volume *</label>
                                                            <select className="w-full border-gray-300 rounded-md border p-2 focus:ring-2 focus:ring-blue-500 outline-none" value={line.volume} onChange={(e) => updateProductLine(line.id, 'volume', e.target.value)}>
                                                                <option value="">S√©lectionner</option>
                                                                {volumeOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700 mb-1">Quantit√© *</label>
                                                            <select className="w-full border-gray-300 rounded-md border p-2 focus:ring-2 focus:ring-blue-500 outline-none" value={line.quantity} onChange={(e) => updateProductLine(line.id, 'quantity', e.target.value)}>
                                                                <option value="">S√©lectionner</option>
                                                                {quantityOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                            </select>
                                                        </div>
                                                        <div className="flex flex-col justify-center">
                                                            <label className="block text-sm font-medium text-gray-700 mb-1">Logo *</label>
                                                            <label className="flex items-center space-x-2 cursor-pointer p-2 border rounded bg-white hover:bg-blue-50">
                                                                <input type="checkbox" className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" checked={line.hasLogo} onChange={(e) => updateProductLine(line.id, 'hasLogo', e.target.checked)} />
                                                                <span className="text-sm text-gray-600">Avec logo ?</span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <button onClick={addProductLine} className="flex items-center gap-2 text-blue-600 font-medium hover:bg-blue-50 px-4 py-2 rounded transition-colors w-fit">
                                            <Plus size={18} /> Ajouter une ligne de demande
                                        </button>
                                    </>
                                ) : (
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">D√©crivez-nous bri√®vement votre besoin</label>
                                        <textarea className="w-full min-h-[200px] border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: Je souhaite 500 sacs rouges de 100L..." value={manualText} onChange={(e) => setManualText(e.target.value)} />
                                    </div>
                                )}
                                <div className="pt-6 border-t mt-4">
                                    <label className="flex items-center space-x-3 cursor-pointer">
                                        <div className="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                            <input type="checkbox" className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" style={{ right: isManualRequest ? '0' : 'auto', left: isManualRequest ? 'auto' : '0' }} checked={isManualRequest} onChange={toggleManualMode} />
                                            <label className={`toggle-label block overflow-hidden h-6 rounded-full cursor-pointer ${isManualRequest ? 'bg-blue-600' : 'bg-gray-300'}`}></label>
                                        </div>
                                        <span className="text-gray-700 font-medium">Je pr√©f√®re √©crire ma demande</span>
                                    </label>
                                </div>
                            </div>
                        )}

                        {/* STEP 2 */}
                        {step === 2 && (
                            <div className="animate-fade-in space-y-6">
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-800 mb-4">D√©lai de livraison souhait√© *</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                        {deliveryDelays.map((delay) => (
                                            <label key={delay} onClick={() => handleDelaySelect(delay)} className={`cursor-pointer border p-3 rounded-lg flex items-center justify-center text-center transition-all ${deliveryInfo.deliveryDelay === delay ? 'border-blue-600 bg-blue-50 text-blue-700 font-bold shadow-sm' : 'border-gray-200 hover:border-blue-300'}`}>
                                                <input type="radio" name="delivery" className="hidden" value={delay} checked={deliveryInfo.deliveryDelay === delay} onChange={() => {}} />
                                                {delay}
                                            </label>
                                        ))}
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Nom de l'entreprise *</label>
                                        <input type="text" className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" value={deliveryInfo.companyName} onChange={(e) => setDeliveryInfo({...deliveryInfo, companyName: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Code postal *</label>
                                        <input type="text" className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" value={deliveryInfo.zipCode} onChange={(e) => setDeliveryInfo({...deliveryInfo, zipCode: e.target.value})} />
                                    </div>
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Secteur d'activit√© *</label>
                                        <input type="text" placeholder="Ex: BTP, nettoyage, secteur public..." className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" value={deliveryInfo.sector} onChange={(e) => setDeliveryInfo({...deliveryInfo, sector: e.target.value})} />
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* STEP 3 */}
                        {step === 3 && (
                            <div className="animate-fade-in space-y-6">
                                <div className="bg-blue-50 border border-blue-100 p-4 rounded-lg flex gap-3 items-start">
                                    <ShieldCheck size={24} className="text-blue-600 shrink-0 mt-1" />
                                    <div>
                                        <h4 className="font-bold text-blue-800 text-sm">Pas de panique !</h4>
                                        <p className="text-sm text-blue-700 mt-1">Vos donn√©es sont en s√©curit√©. Votre technicien pourrait simplement vous demander des informations compl√©mentaires pour votre dossier afin de vous fournir une estimation bien plus pr√©cise.</p>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 gap-5">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Nom complet *</label>
                                        <input type="text" className="w-full border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-blue-500 outline-none" value={contactInfo.name} onChange={(e) => setContactInfo({...contactInfo, name: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Email professionnel *</label>
                                        <input type="email" className="w-full border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-blue-500 outline-none" value={contactInfo.email} onChange={(e) => setContactInfo({...contactInfo, email: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Num√©ro de t√©l√©phone *</label>
                                        <input type="tel" className="w-full border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-blue-500 outline-none" value={contactInfo.phone} onChange={(e) => setContactInfo({...contactInfo, phone: e.target.value})} />
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* FOOTER */}
                        <div className="mt-auto pt-8 flex justify-between items-center border-t border-gray-100">
                            {step > 1 ? (
                                <button onClick={handlePrev} className="px-6 py-2.5 text-gray-600 font-medium hover:bg-gray-100 rounded-lg transition-colors flex items-center gap-2">
                                    <ChevronLeft size={18} /> Pr√©c√©dent
                                </button>
                            ) : (
                                <div className="text-xs text-gray-400">Vos donn√©es sont prot√©g√©es (RGPD).</div>
                            )}
                            <button onClick={step === 3 ? handleSubmit : handleNext} disabled={loading} className={`px-8 py-2.5 bg-blue-700 hover:bg-blue-800 text-white font-semibold rounded-lg shadow-lg shadow-blue-200 transition-all flex items-center gap-2 ${loading ? 'opacity-70 cursor-not-allowed' : ''}`}>
                                {loading ? 'Redirection...' : step === 3 ? 'Demander mon devis' : 'Suivant'}
                                {!loading && step !== 3 && <ChevronRight size={18} />}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<QuoteForm />);
    </script>
</body>
</html>
