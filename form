<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demande de Devis</title>
    
    <!-- Tailwind CSS pour le style -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel pour compiler le JSX dans le navigateur -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Animation simple pour les transitions */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        /* Style personnalisé pour les checkbox toggle */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #2563EB;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #2563EB;
        }
        
        /* Scrollbar propre */
        body { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-slate-800 min-h-screen flex items-center justify-center p-4 font-sans text-slate-800">

    <!-- Point d'ancrage pour l'application React -->
    <div id="root" class="w-full max-w-4xl"></div>

    <script type="text/babel">
        const { useState } = React;

        // --- ICONES SVG (Intégrées pour éviter les dépendances externes) ---
        const Trash2 = ({ size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
        );
        const Plus = ({ size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        );
        const Check = ({ size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"></polyline></svg>
        );
        const ChevronRight = ({ size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"></polyline></svg>
        );
        const ChevronLeft = ({ size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="15 18 9 12 15 6"></polyline></svg>
        );
        const Hand = ({ size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"></path><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"></path><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"></path><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"></path></svg>
        );
        const ShieldCheck = ({ size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
        );

        // --- COMPOSANT PRINCIPAL ---
        const QuoteForm = () => {
            // Configuration
            const WEBHOOK_URL = "https://hook.eu1.make.com/87l2637pu1ol9m6ksl75evieh3s9j1vg";

            // State
            const [step, setStep] = useState(1);
            const [loading, setLoading] = useState(false);
            const [isManualRequest, setIsManualRequest] = useState(false);

            const [productLines, setProductLines] = useState([
                { id: 1, type: '', volume: '', quantity: '', hasLogo: false }
            ]);
            
            const [manualText, setManualText] = useState('');

            const [deliveryInfo, setDeliveryInfo] = useState({
                deliveryDelay: '',
                companyName: '',
                sector: '',
                zipCode: ''
            });

            const [contactInfo, setContactInfo] = useState({
                name: '',
                email: '',
                phone: ''
            });

            // Options
            const sacTypes = ["Standard renforcé (BTP)", "DASRI (médicale)", "Tri sélectif", "Biodégradable", "Grands contenants", "Autres"];
            const volumeOptions = ["Moins de 10 litres", "10 à 100 litres", "100 à 200 litres", "200 à 300 litres", "300 à 400 litres", "400 à 1000 litres", "Autres"];
            const quantityOptions = ["Moins de 500", "500 à 1000", "1000 à 5000", "Plus de 5000", "Autres"];
            const deliveryDelays = ["Moins de 24 heures", "24 heures", "48 heures", "72 heures"];

            // Logic
            const addProductLine = () => {
                const newId = productLines.length > 0 ? Math.max(...productLines.map(p => p.id)) + 1 : 1;
                setProductLines([...productLines, { id: newId, type: '', volume: '', quantity: '', hasLogo: false }]);
            };

            const removeProductLine = (id) => {
                setProductLines(productLines.filter(line => line.id !== id));
            };

            const updateProductLine = (id, field, value) => {
                setProductLines(productLines.map(line => 
                line.id === id ? { ...line, [field]: value } : line
                ));
            };

            const validateStep1 = () => {
                if (isManualRequest) return manualText.trim().length > 0;
                return productLines.length > 0 && productLines.every(l => l.type && l.volume && l.quantity);
            };

            const validateStep2 = () => {
                return deliveryInfo.deliveryDelay && deliveryInfo.companyName && deliveryInfo.sector && deliveryInfo.zipCode;
            };

            const validateStep3 = () => {
                return contactInfo.name && contactInfo.email && contactInfo.phone;
            };

            const handleNext = () => {
                if (step === 1 && !validateStep1()) {
                    alert("Veuillez remplir les informations produits ou décrire votre besoin.");
                    return;
                }
                if (step === 2 && !validateStep2()) {
                    alert("Veuillez remplir tous les champs de livraison et d'entreprise.");
                    return;
                }
                setStep(prev => prev + 1);
            };

            const handlePrev = () => setStep(prev => prev - 1);

            const handleSubmit = async () => {
                if (!validateStep3()) return;
                setLoading(true);

                // --- MODIFICATION ICI : Parsing en bloc texte ---
                let formattedContent = "";
                if (isManualRequest) {
                    formattedContent = manualText;
                } else {
                    // On transforme le tableau d'objets en une string lisible avec des sauts de ligne
                    formattedContent = productLines.map((line, index) => 
                        `Ligne ${index + 1} : ${line.type} | ${line.volume} | Quantité: ${line.quantity} | Logo: ${line.hasLogo ? 'OUI' : 'NON'}`
                    ).join('\n');
                }
                // -----------------------------------------------

                const payload = {
                    type_demande: isManualRequest ? "Manuelle" : "Liste de produits",
                    contenu_demande: formattedContent, // C'est maintenant une string unique
                    livraison: deliveryInfo,
                    contact: contactInfo,
                    date_soumission: new Date().toISOString()
                };

                try {
                    if (window.dataLayer) {
                        window.dataLayer.push({ event: 'form_submit' });
                    } else {
                        window.dataLayer = [{ event: 'form_submit' }];
                    }

                    const response = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (response.ok) {
                        setStep(4);
                    } else {
                        alert("Une erreur est survenue lors de l'envoi. Veuillez réessayer.");
                    }
                } catch (error) {
                    console.error("Erreur:", error);
                    alert("Erreur de connexion.");
                } finally {
                    setLoading(false);
                }
            };

            // Render
            const ProgressBar = () => (
                <div className="flex justify-between items-center mb-8 px-4">
                    {[1, 2, 3].map((num) => (
                        <div key={num} className="flex flex-col items-center flex-1 relative">
                            <div className={`w-full h-1 absolute top-1/2 -translate-y-1/2 -z-10 ${num === 1 ? 'left-1/2' : num === 3 ? 'right-1/2' : ''} bg-gray-200 hidden md:block`}></div>
                            <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm transition-all duration-300 z-10 ${step >= num ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-500'}`}>
                                {step > num ? <Check size={16} /> : num}
                            </div>
                        </div>
                    ))}
                </div>
            );

            return (
                <div className="bg-white w-full rounded-xl shadow-2xl overflow-hidden min-h-[500px] flex flex-col">
                    {/* Header */}
                    <div className="bg-gray-50 border-b p-6 flex items-center gap-3">
                        <div className="bg-yellow-400 p-2 rounded-full text-white">
                            <Hand size={20} className="fill-current" />
                        </div>
                        <div>
                            <h1 className="text-xl font-bold text-blue-900">Devis gratuit et personnalisé</h1>
                            <p className="text-sm text-gray-500">Réponse sous 24h garantie</p>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="p-6 md:p-8 flex-1 flex flex-col">
                        {step < 4 && <ProgressBar />}

                        {/* STEP 1 */}
                        {step === 1 && (
                            <div className="animate-fade-in space-y-6">
                                <p className="text-gray-700 font-medium">Décrivez vos besoins pour recevoir un devis gratuit aux meilleurs prix du marché.</p>
                                {!isManualRequest ? (
                                    <>
                                        <div className="space-y-4">
                                            {productLines.map((line, index) => (
                                                <div key={line.id} className="p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm relative transition-all hover:shadow-md">
                                                    <div className="flex justify-between items-center mb-3">
                                                        <span className="font-semibold text-blue-800">Ligne produit #{index + 1}</span>
                                                        {productLines.length > 1 && (
                                                            <button onClick={() => removeProductLine(line.id)} className="text-red-500 hover:text-red-700">
                                                                <Trash2 size={18} />
                                                            </button>
                                                        )}
                                                    </div>
                                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700 mb-1">Type de sac *</label>
                                                            <select className="w-full border-gray-300 rounded-md border p-2 focus:ring-2 focus:ring-blue-500 outline-none" value={line.type} onChange={(e) => updateProductLine(line.id, 'type', e.target.value)}>
                                                                <option value="">Sélectionner</option>
                                                                {sacTypes.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700 mb-1">Taille / Volume *</label>
                                                            <select className="w-full border-gray-300 rounded-md border p-2 focus:ring-2 focus:ring-blue-500 outline-none" value={line.volume} onChange={(e) => updateProductLine(line.id, 'volume', e.target.value)}>
                                                                <option value="">Sélectionner</option>
                                                                {volumeOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700 mb-1">Quantité *</label>
                                                            <select className="w-full border-gray-300 rounded-md border p-2 focus:ring-2 focus:ring-blue-500 outline-none" value={line.quantity} onChange={(e) => updateProductLine(line.id, 'quantity', e.target.value)}>
                                                                <option value="">Sélectionner</option>
                                                                {quantityOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                            </select>
                                                        </div>
                                                        <div className="flex flex-col justify-center">
                                                            <label className="block text-sm font-medium text-gray-700 mb-1">Logo *</label>
                                                            <label className="flex items-center space-x-2 cursor-pointer p-2 border rounded bg-white hover:bg-blue-50">
                                                                <input type="checkbox" className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" checked={line.hasLogo} onChange={(e) => updateProductLine(line.id, 'hasLogo', e.target.checked)} />
                                                                <span className="text-sm text-gray-600">Avec logo ?</span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <button onClick={addProductLine} className="flex items-center gap-2 text-blue-600 font-medium hover:bg-blue-50 px-4 py-2 rounded transition-colors w-fit">
                                            <Plus size={18} /> Ajouter une ligne de demande
                                        </button>
                                    </>
                                ) : (
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Décrivez-nous brièvement votre besoin</label>
                                        <textarea className="w-full min-h-[200px] border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: Je souhaite 500 sacs rouges de 100L..." value={manualText} onChange={(e) => setManualText(e.target.value)} />
                                    </div>
                                )}
                                <div className="pt-6 border-t mt-4">
                                    <label className="flex items-center space-x-3 cursor-pointer">
                                        <div className="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                            <input type="checkbox" className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" style={{ right: isManualRequest ? '0' : 'auto', left: isManualRequest ? 'auto' : '0' }} checked={isManualRequest} onChange={() => setIsManualRequest(!isManualRequest)} />
                                            <label className={`toggle-label block overflow-hidden h-6 rounded-full cursor-pointer ${isManualRequest ? 'bg-blue-600' : 'bg-gray-300'}`}></label>
                                        </div>
                                        <span className="text-gray-700 font-medium">Je préfère écrire ma demande</span>
                                    </label>
                                </div>
                            </div>
                        )}

                        {/* STEP 2 */}
                        {step === 2 && (
                            <div className="animate-fade-in space-y-6">
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-800 mb-4">Délai de livraison souhaité *</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                        {deliveryDelays.map((delay) => (
                                            <label key={delay} className={`cursor-pointer border p-3 rounded-lg flex items-center justify-center text-center transition-all ${deliveryInfo.deliveryDelay === delay ? 'border-blue-600 bg-blue-50 text-blue-700 font-bold shadow-sm' : 'border-gray-200 hover:border-blue-300'}`}>
                                                <input type="radio" name="delivery" className="hidden" value={delay} checked={deliveryInfo.deliveryDelay === delay} onChange={(e) => setDeliveryInfo({...deliveryInfo, deliveryDelay: e.target.value})} />
                                                {delay}
                                            </label>
                                        ))}
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Nom de l'entreprise *</label>
                                        <input type="text" className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" value={deliveryInfo.companyName} onChange={(e) => setDeliveryInfo({...deliveryInfo, companyName: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Code postal *</label>
                                        <input type="text" className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" value={deliveryInfo.zipCode} onChange={(e) => setDeliveryInfo({...deliveryInfo, zipCode: e.target.value})} />
                                    </div>
                                    <div className="md:col-span-2">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Secteur d'activité *</label>
                                        <input type="text" placeholder="Ex: BTP, nettoyage, secteur public..." className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" value={deliveryInfo.sector} onChange={(e) => setDeliveryInfo({...deliveryInfo, sector: e.target.value})} />
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* STEP 3 */}
                        {step === 3 && (
                            <div className="animate-fade-in space-y-6">
                                <div className="bg-blue-50 border border-blue-100 p-4 rounded-lg flex gap-3 items-start">
                                    <ShieldCheck size={24} className="text-blue-600 shrink-0 mt-1" />
                                    <div>
                                        <h4 className="font-bold text-blue-800 text-sm">Pas de panique !</h4>
                                        <p className="text-sm text-blue-700 mt-1">Vos données sont en sécurité. Votre technicien pourrait simplement vous demander des informations complémentaires pour votre dossier afin de vous fournir une estimation bien plus précise.</p>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 gap-5">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Nom complet *</label>
                                        <input type="text" className="w-full border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-blue-500 outline-none" value={contactInfo.name} onChange={(e) => setContactInfo({...contactInfo, name: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Email professionnel *</label>
                                        <input type="email" className="w-full border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-blue-500 outline-none" value={contactInfo.email} onChange={(e) => setContactInfo({...contactInfo, email: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Numéro de téléphone *</label>
                                        <input type="tel" className="w-full border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-blue-500 outline-none" value={contactInfo.phone} onChange={(e) => setContactInfo({...contactInfo, phone: e.target.value})} />
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* SUCCESS STEP 4 */}
                        {step === 4 && (
                            <div className="flex flex-col items-center justify-center text-center h-full animate-fade-in py-10">
                                <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6">
                                    <Check size={40} className="text-green-600" />
                                </div>
                                <h2 className="text-2xl font-bold text-gray-900 mb-2">Demande envoyée !</h2>
                                <p className="text-gray-600 max-w-md">Merci {contactInfo.name}. Un technicien analyse votre demande et va vous envoyer un devis avec les meilleurs prix du marché très rapidement.</p>
                            </div>
                        )}

                        {/* FOOTER */}
                        {step < 4 && (
                            <div className="mt-auto pt-8 flex justify-between items-center border-t border-gray-100">
                                {step > 1 ? (
                                    <button onClick={handlePrev} className="px-6 py-2.5 text-gray-600 font-medium hover:bg-gray-100 rounded-lg transition-colors flex items-center gap-2">
                                        <ChevronLeft size={18} /> Précédent
                                    </button>
                                ) : (
                                    <div className="text-xs text-gray-400">Vos données sont protégées (RGPD).</div>
                                )}
                                <button onClick={step === 3 ? handleSubmit : handleNext} disabled={loading} className={`px-8 py-2.5 bg-blue-700 hover:bg-blue-800 text-white font-semibold rounded-lg shadow-lg shadow-blue-200 transition-all flex items-center gap-2 ${loading ? 'opacity-70 cursor-not-allowed' : ''}`}>
                                    {loading ? 'Envoi...' : step === 3 ? 'Demander mon devis' : 'Suivant'}
                                    {!loading && step !== 3 && <ChevronRight size={18} />}
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<QuoteForm />);
    </script>
</body>
</html>
